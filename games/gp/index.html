<!DOCTYPE html>
<html>
<head>
  <title>Google Photos Picker Simple</title>
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>

<button id="authorize_button">Authorize & Pick Albums</button>

<ul id="albumsList"></ul>

<script>
  const CLIENT_ID = '760790473830-dp76nebbcm55339in7890fme1tshvp73.apps.googleusercontent.com';
  const SCOPES = 'https://www.googleapis.com/auth/photoslibrary.readonly.appcreateddata';

  let tokenClient;
  let accessToken = null;

  document.getElementById('authorize_button').onclick = handleAuthClick;

  function handleAuthClick() {
    gapi.load('client', initializeGapiClient);
  }

  async function initializeGapiClient() {
    await gapi.client.init({
      apiKey: '', // optional if you only use OAuth token
      discoveryDocs: ['https://photoslibrary.googleapis.com/$discovery/rest?version=v1']
    });

    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: 'https://www.googleapis.com/auth/photoslibrary.readonly',
      callback: (tokenResponse) => {
        accessToken = tokenResponse.access_token;
        launchPicker();
      },
    });

    tokenClient.requestAccessToken();
  }

  function launchPicker() {
    const picker = new google.picker.PickerBuilder()
      .addView(new google.picker.PhotosView(google.picker.ViewId.ALBUMS))
      .setOAuthToken(accessToken)
      .setDeveloperKey('') // your API key, optional if using OAuth token
      .setCallback(pickerCallback)
      .build();

    picker.setVisible(true);
  }

  function pickerCallback(data) {
    if (data.action === google.picker.Action.PICKED) {
      const albumsList = document.getElementById('albumsList');
      albumsList.innerHTML = '';

      const docs = data.docs || [];
      const albums = docs.filter(doc => doc.type === 'album');

      // Extract album names and send to PHP
      const albumNames = albums.map(album => album.name);
      albumNames.forEach(name => {
        const li = document.createElement('li');
        li.textContent = name;
        albumsList.appendChild(li);
      });

      // Send album names to PHP
      fetch('save_albums.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ albums: albumNames }),
      }).then(res => res.text())
        .then(console.log)
        .catch(console.error);
    }
  }
</script>

<script src="https://apis.google.com/js/api.js?onload=handleAuthClick"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://apis.google.com/js/api.js?onload=handleAuthClick"></script>
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js"></script>

</body>
</html>
